# Механика пулов вознаграждений и типов спинов

## Оглавление
- [Термины](#термины)
- [Типы спинов](#типы-спинов)
    - [Guaranteed spin](#guaranteed-spin)
    - [Not full spin](#not-full-spin)
    - [Full spin](#full-spin)
- [Серверный процесс “получить приз”](#серверный-процесс-получить-приз)
- [Параметры, влияющие на вероятность](#параметры-влияющие-на-вероятность)
- [Алгоритм наполнения пулов](#алгоритм-наполнения-пулов)
    - [Not full пул](#not-full-пул)
    - [Full пул](#full-пул)
        - [Silver](#silver)
        - [Gold](#gold)
        - [Platinum](#platinum)
- [Примеры расчёта вероятностей](#примеры-расчёта-вероятностей)
    - [Пример: Silver](#пример-silver)
    - [Пример: Gold](#пример-gold)
    - [Пример: Platinum](#пример-platinum)
- [Итоговые правила вероятностей](#итоговые-правила-вероятностей)
- [Примечания](#примечания)

---

## Термины

### Пул вознаграждений
**Пул вознаграждений** — это список, из которого рандомайзер во время спина случайным образом выбирает **1** вознаграждение.

- Размер пула = длина списка.
- Вероятность выпадения конкретного типа награды определяется количеством мест этого типа в пуле и общей длиной пула.

---

## Типы спинов

### Guaranteed spin
**Guaranteed spin** — приветственные спины с гарантированным ценным вознаграждением (не тикетом).

Приветственные спины — это спины за:
- **1-й код**
- **3-й код**
- **5-й код**

В этих случаях призы — **балансы уровня welcome**.

Особенность:
- Размер пула = **1**
- Пул состоит из **1 элемента** (welcome balance)
- Рандомайзер выбирает 1 из 1 → шанс получить награду = **100%**

Также есть доп. механика (настраиваемая):
- для уровня **silver** можно включить гарантированную выдачу, если за **X** спинов пользователь не получил ни одного **silver** приза:
    - пул наполняется **только** призами/балансами уровня **silver** (без тикетов)

---

### Not full spin
**Not full spin** — спин с пониженным шансом.  
Пул розыгрыша включает:
- балансы уровня **inter**
- тикеты

---

### Full spin
**Full spin** — полноценный спин.  
Среди потенциальных вознаграждений:
- тикеты
- балансы
- призы

---

## Серверный процесс “получить приз”

Когда пользователь нажимает кнопку **“получить приз”**, сервер выполняет:

### 0. Проверка возможности спина
- Если у пользователя **нет** возможности спинить → ошибка
- Если **есть** → продолжаем

### 1. Спин за первый код
- Создаёт пул длиной 1
- Заполняет его балансом welcome
- Выбирает приз (welcome balance)
- Списывает 1 код
- Отдаёт награду

### 2. Спин за третий код
- Создаёт пул длиной 1
- Заполняет его балансом welcome
- Выбирает приз (welcome balance)
- Списывает 2 кода
- Отдаёт награду

### 3. Спин за пятый код
- Создаёт пул длиной 1
- Заполняет его балансом welcome
- Выбирает приз (welcome balance)
- Списывает 2 кода
- Отдаёт награду

### 4. Спин за контент или за 7+ код
- Определяет тип спина: **full** или **not full**
- Наполняет пул вознаграждениями
- Выбирает приз
- Списывает активности (1 content или 2 code - в зависимости от сценария)
- Отдаёт награду

---

## Параметры, влияющие на вероятность

- `code.full.spin.chance` (0..100, default **66**)  
  Шанс попасть на **full spin** при списании активности типа `code`

- `content.full.spin.chance` (0..100, default **50**)  
  Шанс попасть на **full spin** при списании активности типа `content`

- `spin.pool.length` (>=1, default **10**)  
  Общий размер пула

- `spin.pool.prizes.number` (>=0, default **5**)  
  Количество **призовых мест** (балансы + сертификаты + материальные призы), добавляемых в пул

- `spin.pool.silver.balances.number` (>=0, default **3**)  
  Количество **silver** балансов в пуле уровня silver

- `spin.pool.gold.balances.number` (>=0, default **2**)  
  Количество **gold** балансов в пуле уровня gold

- `spin.pool.platinum.balances.number` (>=0, default **2**)  
  Количество **platinum** балансов в пуле уровня platinum

- `additional.silver.prizes.number.at.gold` (>=0, default **1**)  
  Количество **silver** призов в пуле уровня gold

- `additional.silver.prizes.number.at.platinum` (>=0, default **1**)  
  Количество **silver** призов в пуле уровня platinum

- `additional.gold.prizes.number.at.platinum` (>=0, default **1**)  
  Количество **gold** призов в пуле уровня platinum

---

## Алгоритм наполнения пулов

### Not full пул

1. Берётся `spin.pool.length`, создаётся пустой список такой длины
2. В пул добавляется **один баланс уровня inter** (если такие есть в игре)
3. Остальные свободные места в пуле заполняются **тикетами**

---

### Full пул

#### Silver

1. Берётся `spin.pool.length`, создаётся пустой список такой длины — **пул**
2. Добавляются балансы уровня **silver** в количестве `spin.pool.silver.balances.number`
3. Добавляются призы уровня **silver** в количестве:
    - `spin.pool.prizes.number минус (места, занятые балансами из п.2)`
4. Остальные свободные места заполняются **тикетами**

---

#### Gold

1. Берётся `spin.pool.length`, создаётся пустой список такой длины — **пул**
2. Добавляются балансы уровня **gold** в количестве `spin.pool.gold.balances.number`
3. Добавляются призы уровня **silver** в количестве:
    - `additional.silver.prizes.number.at.gold`
    - но не занимая места сверх доступных (после п.2)
4. Добавляются призы уровня **gold** в количестве:
    - `spin.pool.prizes.number минус (места, занятые в п.2 и п.3)`
    - но не больше, чем `spin.pool.prizes.number`
5. Остальные свободные места заполняются **тикетами**

---

#### Platinum

1. Берётся `spin.pool.length`, создаётся пустой список такой длины — **пул**
2. Добавляются балансы уровня **platinum** в количестве `spin.pool.platinum.balances.number`
3. Добавляются призы уровня **silver** в количестве:
    - `additional.silver.prizes.number.at.platinum`
    - за вычетом уже занятых мест (п.2)
4. Добавляются призы уровня **gold** в количестве:
    - `additional.gold.prizes.number.at.platinum`
    - за вычетом уже занятых мест (п.2 и п.3)
5. Добавляется **один приз уровня platinum** (не конфигурируется)
6. Остальные свободные места заполняются **тикетами**

---

## Примеры расчёта вероятностей

### Пример: Silver

Настройки:
- `spin.pool.length = 100`
- `spin.pool.prizes.number = 15`
- `spin.pool.silver.balances.number = 10`

Распределение:
- балансы silver: `10`
- призы silver: `15 - 10 = 5`
- тикеты: `100 - 10 - 5 = 85`

Вероятности:
- тикет: `85/100 = 0.85`
- баланс: `10/100 = 0.10`
- приз: `5/100 = 0.05`

---

### Пример: Gold

Настройки:
- `spin.pool.length = 100`
- `spin.pool.prizes.number = 15`
- `spin.pool.gold.balances.number = 10`
- `additional.silver.prizes.number.at.gold = 1`

Распределение:
- балансы gold: `10`
- призы silver: `1`
- призы gold: `15 - 10 - 1 = 4`
- тикеты: `100 - 10 - 1 - 4 = 85`

Вероятности:
- тикет: `85/100 = 0.85`
- баланс: `10/100 = 0.10`
- приз gold: `4/100 = 0.04`
- приз silver: `1/100 = 0.01`

---

### Пример: Platinum

Настройки:
- `spin.pool.length = 100`
- `spin.pool.platinum.balances.number = 10`
- `additional.silver.prizes.number.at.platinum = 1`
- `additional.gold.prizes.number.at.platinum = 1`

Распределение:
- балансы platinum: `10`
- призы silver: `1`
- призы gold: `1`
- призы platinum: `1` (не конфигурируется)
- тикеты: `100 - 10 - 1 - 1 - 1 = 87`

Вероятности:
- тикет: `87/100 = 0.87`
- баланс: `10/100 = 0.10`
- приз platinum: `1/100 = 0.01`
- приз gold: `1/100 = 0.01`
- приз silver: `1/100 = 0.01`

---

## Итоговые правила вероятностей

- Вероятность выпадения **баланса** на уровне L определяется:
    - общей длиной пула `spin.pool.length`
    - количеством балансов уровня L
    - и ограничением: **балансов и призов в сумме не может быть больше, чем `spin.pool.prizes.number`**

- Вероятность выпадения **приза**:
    - на уровне **silver** зависит от разницы между `spin.pool.prizes.number` и числом мест, занятых балансами silver
    - на уровне **gold** зависит от разницы между `spin.pool.prizes.number` и числом мест, занятых балансами gold и silver-призами (additional)
    - на уровне **platinum** зависит от занятых мест балансами platinum, silver-призами (additional), gold-призами (additional) и фиксированным 1 местом под platinum-приз

### Примечания:
- если балансами и дополнительными призами заняты все места, выделенные под `spin.pool.prizes.number`, призы текущего уровня в пул не попадут
